package StepDefinitions;

import com.github.dockerjava.core.dockerfile.DockerfileStatement.Add;
import com.pages.bsCheckout;
import com.pages.bsConfirmation;
import com.pages.bsHome;
import com.pages.bsSignin;
import io.cucumber.java.Before;
import io.cucumber.java.Scenario;
import io.cucumber.java.en.And;
import io.cucumber.java.en.Given;
import io.cucumber.java.en.Then;
import io.cucumber.java.en.When;
import org.openqa.selenium.JavascriptExecutor;
import org.testng.Assert;
import org.yaml.snakeyaml.Yaml;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.Map;

public class CartSteps {
    ApplicationHooks hooks;
    private final bsHome bshome;
    private final bsSignin bssignin;
    private final bsCheckout bschecokout;
    private final bsConfirmation bsconfirm;

    public CartSteps(ApplicationHooks hooks) {
        this.hooks = hooks;
        bshome = new bsHome(hooks.driver);
        bssignin = new bsSignin(hooks.driver);
        bschecokout = new bsCheckout(hooks.driver);
        bsconfirm = new bsConfirmation(hooks.driver);
    }

    Scenario sc;

    @Before
    public void getScenario(Scenario scenario) {
        this.sc = scenario;
    }

    @Given("User is on home page")
    public void user_is_on_home_page() throws FileNotFoundException {
        JavascriptExecutor jse = (JavascriptExecutor) hooks.driver;
        Map<String, String> deviceInfo = new HashMap<>();
        try {
            deviceInfo = (Map<String, String>) jse.executeScript("mobile:deviceInfo");
        } catch (Exception e) {
            deviceInfo = null;
        }
        if (deviceInfo != null && deviceInfo.get("model").toLowerCase().matches(".*(iphone|ipad).*"))
            hooks.driver
                    .get(System.getProperties().getProperty("Application_url").replaceAll("localhost", "bs-local.com"));
        else
            hooks.driver.get(System.getProperties().getProperty("Application_url"));
        Yaml yaml = new Yaml();
        InputStream inputStream = new FileInputStream("browserstack.yml");
        HashMap yamlMap = yaml.load(inputStream);
        if (yamlMap.get("browserstackAutomation").toString().equalsIgnoreCase("true")) {
            jse.executeScript("browserstack_executor: {\"action\":\"lighthouseAudit\",\"arguments\":{\"url\":\""
                    + hooks.driver.getCurrentUrl() + "\",\"executorOutput\":\"json\"}}");

            jse.executeScript("browserstack_executor: {\"action\":\"lighthouseAudit\",\"arguments\":{\"url\":\""
                    + hooks.driver.getCurrentUrl()
                    + "\",\"assertResult\":{\"categories\":{\"performance\":40,\"best-practices\":50},\"metrics\":{\"first-contentful-paint\":{\"moreThan\":50,\"metricUnit\":\"score\"},\"largest-contentful-paint\":{\"lessThan\":4000,\"metricUnit\":\"numeric\"},\"total-blocking-time\":{\"lessThan\":600,\"metricUnit\":\"numeric\"},\"cumulative-layout-shift\":{\"moreThan\":50,\"metricUnit\":\"score\"}}}}}");
        }
    }

    @When("User clicks on {string} Add To Cart button {int} times")
    public void user_clicks_on_add_to_cart(String deviceName, int clicks) {
        bshome.addToCartNTimes(deviceName, clicks);
    }

    @Then("The Cart gets updated with {string} and {int}")
    public void cart_is_updated(String deviceName, int quantity) {
        boolean cartUpdate = bshome.verifyCart(deviceName, quantity);
        Assert.assertTrue(cartUpdate);
        sc.log("cart updated successfully");
    }

}